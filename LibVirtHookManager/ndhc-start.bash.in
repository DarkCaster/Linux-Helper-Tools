#!/bin/bash

find_command ip
find_command dhclient
find_command ifconfig

if [[ ! -f ${cfg[hooks.$hook_cnt.pid]} ]]; then
  if [[ ${cfg[hooks.$hook_cnt.setup_local]} = true ]]; then
    debug "setting up local network-interface"
    ip netns exec "${cfg[hooks.$hook_cnt.netns]}" ifconfig lo 127.0.0.1/8
  fi
  debug "starting dhclient"
  ip netns exec "${cfg[hooks.$hook_cnt.netns]}" nohup "$dhclient" -4 -d -v -lf "${cfg[hooks.$hook_cnt.leases]}" -pf "${cfg[hooks.$hook_cnt.pid]}" >"${cfg[hooks.$hook_cnt.log]}" 2>&1 &
  wait_for_pid_created "${cfg[hooks.$hook_cnt.pid]}" "$dhclient" && debug "dhclient startup confirmed"
else
  debug "pid file ${cfg[hooks.$hook_cnt.pid]} already present, cannot proceed!"
  false
fi
